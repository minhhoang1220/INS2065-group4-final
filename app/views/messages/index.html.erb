<div class="max-w-3xl mx-auto px-4 pb-20">
  <% if @match %>
    <h1 class="font-bold text-3xl mb-6">Chat with <%= @other_user.name %></h1>

    <div class="message-history mb-20 space-y-4" style="max-height: calc(100vh - 250px); overflow-y-auto;">
      <% @messages.each do |message| %>
        <%= render 'message', message: message %>
      <% end %>
    </div>

    <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-4">
      <div class="max-w-3xl mx-auto">
        <%= form_with(model: [@match, Message.new], local: true, class: "relative") do |form| %>
          <div class="flex items-center">
            <%= form.text_area :messageText,
                class: "w-full border rounded-full py-3 px-6 pr-16 focus:outline-none focus:border-[#00B6FF]",
                placeholder: "Type a message...",
                rows: 1,
                onkeydown: "if(event.keyCode==13 && !event.shiftKey){event.preventDefault(); this.form.submit();}" %>
            <div class="absolute right-0 flex items-center pr-3">
              <button type="submit" class="text-[#00B6FF] hover:text-[#0095DB]">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-7 h-7">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                </svg>
              </button>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% else %>
    <h1 class="font-bold text-3xl mb-6">Your Conversations</h1>
    
    <div class="matches-list space-y-4">
      <% @matches.each do |match| %>
        <% other_user = match.get_other_profile(current_user.usertable.id) %>
        <%= link_to match_messages_path(match), class: "block" do %>
          <div class="match-item p-4 border rounded-lg hover:bg-gray-50 transition-colors">
            <div class="font-semibold"><%= other_user.name %></div>
            <% last_message = match.messages.order(messageTimestamp: :desc).first %>
            <% if last_message %>
              <div class="text-sm text-gray-600 mt-1">
                <%= truncate(last_message.messageText, length: 50) %>
                <span class="text-xs text-gray-500">
                  Â· <%= time_ago_in_words(last_message.messageTimestamp) %> ago
                </span>
              </div>
            <% end %>
          </div>
        <% end %>
      <% end %>
    </div>
  <% end %>
</div>

<% content_for :scripts do %>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const messageHistory = document.querySelector('.message-history');
      if (messageHistory) {
        messageHistory.scrollTop = messageHistory.scrollHeight;
      }
    });
  </script>
<% end %>
